#cloud-config
# HecateOS Autoinstall Configuration
#
# CUSTOMIZATION REQUIRED: This is a TEMPLATE. Before use, modify:
# 1. storage.config[0].path - Set to YOUR target disk (e.g., /dev/nvme0n1, /dev/sda)
# 2. identity.username - Set YOUR username
# 3. identity.password - Generate with: mkpasswd --method=SHA-512 yourpassword
# 4. identity.realname - Set YOUR name
# 5. keyboard.layout - Set YOUR keyboard layout (us, es, de, fr, etc.)
#
# To find your disk: lsblk or fdisk -l
# WARNING: This will ERASE the target disk completely!

autoinstall:
  version: 1

  # Localization - CUSTOMIZE keyboard layout
  locale: en_US.UTF-8
  keyboard:
    layout: us  # Change to your layout: us, es, de, fr, uk, etc.
    variant: ''
    toggle: null

  # Network configuration (DHCP on first ethernet)
  network:
    network:
      version: 2
      ethernets:
        id0:
          match:
            driver: "*"
          dhcp4: true
          dhcp6: true

  # Storage configuration
  # IMPORTANT: Change path to YOUR disk!
  storage:
    config:
      - id: target_disk
        type: disk
        ptable: gpt
        # >>> CHANGE THIS to your target disk <<<
        # Examples: /dev/nvme0n1, /dev/sda, /dev/vda
        path: /dev/nvme0n1
        wipe: superblock-recursive
        preserve: false
        grub_device: false

      # EFI System Partition (512MB)
      - id: esp_partition
        type: partition
        device: target_disk
        size: 536870912  # 512MB
        flag: boot
        number: 1
        preserve: false
        grub_device: true

      - id: esp_format
        type: format
        volume: esp_partition
        fstype: fat32
        label: HECATE_EFI

      - id: esp_mount
        type: mount
        device: esp_format
        path: /boot/efi

      # Boot Partition (1GB)
      - id: boot_partition
        type: partition
        device: target_disk
        size: 1073741824  # 1GB
        number: 2
        preserve: false

      - id: boot_format
        type: format
        volume: boot_partition
        fstype: ext4
        label: HECATE_BOOT

      - id: boot_mount
        type: mount
        device: boot_format
        path: /boot

      # Root Partition (uses remaining space)
      - id: root_partition
        type: partition
        device: target_disk
        size: -1  # Use all remaining space
        number: 3
        preserve: false

      - id: root_format
        type: format
        volume: root_partition
        fstype: ext4
        label: HECATE_ROOT

      - id: root_mount
        type: mount
        device: root_format
        path: /

  # User configuration - CUSTOMIZE THESE!
  identity:
    hostname: hecate
    # >>> CHANGE username and password <<<
    username: hecate
    # Default password: "hecate" - CHANGE THIS!
    # Generate new hash: mkpasswd --method=SHA-512 yourpassword
    password: "$6$rounds=4096$hecate$LQe2wUJkZ8z8r5QH5FwPY5vL1xJV3r5w5z5x5y5z5a5b5c5d5e5f5g5h5i5j5k5l5m"
    realname: HecateOS User

  # SSH configuration
  ssh:
    install-server: true
    allow-pw: true
    authorized-keys: []

  # Minimal packages (rest installed by HecateOS)
  packages:
    - ubuntu-server
    - openssh-server
    - build-essential
    - git
    - curl
    - wget

  updates: security

  # Post-installation commands
  late-commands:
    # Add user to necessary groups (uses $USER from identity)
    - curtin in-target --target=/target -- usermod -aG sudo,docker,video,render hecate

    # Detect other OS for dual-boot
    - curtin in-target --target=/target -- os-prober || true
    - curtin in-target --target=/target -- update-grub

    # Enable services
    - curtin in-target --target=/target -- systemctl enable ssh
    - curtin in-target --target=/target -- systemctl enable docker || true
    - curtin in-target --target=/target -- systemctl enable nvidia-persistenced || true

    # Set performance tuning
    - curtin in-target --target=/target -- tuned-adm profile throughput-performance || true

    # Create HecateOS marker
    - curtin in-target --target=/target -- touch /etc/hecate-os-installed

  shutdown: reboot

  source:
    id: ubuntu-server
    search_drivers: true

  drivers:
    install: true
