name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Semantic versioning tags only

jobs:
  validate-version:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Validate semantic version
      run: |
        TAG=${GITHUB_REF#refs/tags/}
        if ! [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "Error: Tag $TAG does not follow semantic versioning"
          exit 1
        fi
    
    - name: Check CHANGELOG entry
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
          echo "Error: No CHANGELOG entry for version $VERSION"
          exit 1
        fi

  release:
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Extract release notes
      id: extract
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        # Extract the release notes for this version from CHANGELOG
        awk "/\[$VERSION\]/,/^## \[/" CHANGELOG.md | head -n -1 > release_notes.md
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
        generate_release_notes: false