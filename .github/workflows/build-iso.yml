name: Build HecateOS ISOs

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      edition:
        description: 'Edition to build (all, ultimate, workstation, gaming, developer, lite, server)'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ultimate
        - workstation
        - gaming
        - developer
        - lite
        - server
  schedule:
    # Build weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './scripts'
        severity: warning

  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Determine editions to build
        id: set-matrix
        run: |
          if [[ "${{ github.event.inputs.edition }}" == "all" ]] || [[ -z "${{ github.event.inputs.edition }}" ]]; then
            echo 'matrix=["ultimate", "workstation", "gaming", "developer", "lite", "server"]' >> $GITHUB_OUTPUT
          else
            echo 'matrix=["${{ github.event.inputs.edition }}"]' >> $GITHUB_OUTPUT
          fi

  build:
    name: Build ${{ matrix.edition }} Edition
    runs-on: ubuntu-22.04
    needs: [lint, prepare]
    strategy:
      matrix:
        edition: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          live-build \
          debootstrap \
          squashfs-tools \
          xorriso \
          isolinux \
          syslinux-efi \
          grub-pc-bin \
          grub-efi-amd64-bin \
          grub-efi-ia32-bin \
          mtools \
          dosfstools

    - name: Cache packages
      uses: actions/cache@v4
      with:
        path: |
          cache/
        key: ${{ runner.os }}-packages-${{ matrix.edition }}-${{ hashFiles('config/package-lists/*.list.chroot') }}
        restore-keys: |
          ${{ runner.os }}-packages-${{ matrix.edition }}-
          ${{ runner.os }}-packages-

    - name: Configure GPG for signed packages
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --import
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --sign --armor --output test.sig --detach-sign README.md
        rm test.sig

    - name: Build ISO
      run: |
        sudo ./editions/build-edition.sh ${{ matrix.edition }}
      env:
        EDITION: ${{ matrix.edition }}

    - name: Calculate checksums
      run: |
        cd iso/
        for iso in *.iso; do
          sha256sum "$iso" > "$iso.sha256"
          md5sum "$iso" > "$iso.md5"
        done
        cd ..

    - name: Test ISO boot
      run: |
        # Quick smoke test with QEMU
        sudo apt-get install -y qemu-system-x86
        ISO_FILE=$(ls iso/*.iso | head -1)
        timeout 30 qemu-system-x86_64 \
          -m 2G \
          -cdrom "$ISO_FILE" \
          -boot d \
          -nographic \
          -serial mon:stdio || true

    - name: Upload ISO artifacts
      uses: actions/upload-artifact@v4
      with:
        name: hecate-os-${{ matrix.edition }}-${{ github.sha }}
        path: |
          iso/*.iso
          iso/*.sha256
          iso/*.md5
        retention-days: 30

    - name: Upload to Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          iso/*.iso
          iso/*.sha256
          iso/*.md5
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        generate_release_notes: true
        body: |
          # HecateOS ${{ github.ref_name }}
          
          ## üì¶ Available Editions
          
          - **Ultimate**: Full-featured for AI/ML workstations
          - **Workstation**: Professional workstation edition
          - **Gaming**: Optimized for gaming and streaming
          - **Developer**: Development-focused edition
          - **Lite**: Lightweight for standard hardware
          - **Server**: Headless server edition
          
          ## üöÄ Installation
          
          1. Download the ISO for your preferred edition
          2. Verify checksum: `sha256sum -c hecate-os-*.sha256`
          3. Create bootable USB: `sudo dd if=hecate-os-*.iso of=/dev/sdX bs=4M status=progress`
          4. Boot and follow the installation wizard
          
          ## üìù What's New
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for details.
          
          ## üîç Verify Downloads
          
          All ISOs are signed and include SHA256 checksums for verification.

  test-matrix:
    name: Test ISOs
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        edition: ["ultimate", "workstation", "gaming", "developer", "lite", "server"]
    
    steps:
    - name: Download ISO artifact
      uses: actions/download-artifact@v4
      with:
        name: hecate-os-${{ matrix.edition }}-${{ github.sha }}
        path: ./test-iso

    - name: Verify ISO integrity
      run: |
        cd test-iso
        sha256sum -c *.sha256
        md5sum -c *.md5

    - name: Check ISO size
      run: |
        cd test-iso
        ISO_SIZE=$(du -h *.iso | cut -f1)
        echo "ISO Size for ${{ matrix.edition }}: $ISO_SIZE"
        
        # Check if size is reasonable
        SIZE_MB=$(du -m *.iso | cut -f1)
        if [[ "${{ matrix.edition }}" == "ultimate" && $SIZE_MB -gt 8000 ]]; then
          echo "Warning: Ultimate edition is larger than 8GB"
        elif [[ "${{ matrix.edition }}" == "lite" && $SIZE_MB -gt 3000 ]]; then
          echo "Warning: Lite edition is larger than 3GB"
        elif [[ "${{ matrix.edition }}" == "server" && $SIZE_MB -gt 2000 ]]; then
          echo "Warning: Server edition is larger than 2GB"
        fi

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build, test-matrix]
    if: always()
    
    steps:
    - name: Send Discord notification
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [[ "${{ needs.build.result }}" == "success" ]]; then
          COLOR=3066993  # Green
          TITLE="‚úÖ HecateOS Build Successful"
          DESC="All ISO editions built successfully!"
        else
          COLOR=15158332  # Red
          TITLE="‚ùå HecateOS Build Failed"
          DESC="One or more ISO editions failed to build."
        fi
        
        curl -X POST $DISCORD_WEBHOOK \
          -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"description\": \"$DESC\",
              \"color\": $COLOR,
              \"fields\": [
                {
                  \"name\": \"Branch\",
                  \"value\": \"${{ github.ref_name }}\",
                  \"inline\": true
                },
                {
                  \"name\": \"Commit\",
                  \"value\": \"${{ github.sha }}\",
                  \"inline\": true
                },
                {
                  \"name\": \"Workflow\",
                  \"value\": \"${{ github.workflow }}\",
                  \"inline\": true
                }
              ],
              \"footer\": {
                \"text\": \"HecateOS CI/CD\"
              },
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
            }]
          }"