name: Build HecateOS ISO

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ludeeus/action-shellcheck@master
      with:
        scandir: './scripts'
        severity: error

  build:
    name: Build ISO
    runs-on: ubuntu-24.04
    needs: lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          live-build \
          debootstrap \
          squashfs-tools \
          xorriso \
          isolinux \
          syslinux-efi \
          grub-pc-bin \
          grub-efi-amd64-bin \
          grub-efi-ia32-bin \
          mtools \
          dosfstools

    - name: Cache packages
      uses: actions/cache@v4
      with:
        path: cache/
        key: ${{ runner.os }}-packages-${{ hashFiles('config/package-lists/*.list.chroot') }}

    - name: Build ISO
      run: sudo ./build.sh build

    - name: Calculate checksums
      run: |
        cd iso/
        for iso in *.iso; do
          sha256sum "$iso" > "$iso.sha256"
        done

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: hecate-os-${{ github.sha }}
        path: |
          iso/*.iso
          iso/*.sha256
        retention-days: 14

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          iso/*.iso
          iso/*.sha256
        generate_release_notes: true
